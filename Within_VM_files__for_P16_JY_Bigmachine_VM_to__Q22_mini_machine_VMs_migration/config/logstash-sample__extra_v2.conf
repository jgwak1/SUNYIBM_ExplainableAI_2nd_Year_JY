# Sample Logstash configuration for creating a simple
# Beats -> Logstash -> Elasticsearch pipeline.

input {
  http {
    port => 5444
  }
}
filter {
  ruby {
    init => "
      system_process_pids = []
      command = 'tasklist /V'
      ps_output = `#{command}`
      ps_output.split(/[\r\n]+/).each do |line|
        if /System |AUTHORITY\\SYSTEM|AUTHORITY\\LOCAL|AUTHORITY\\NETWORK|SilkService|java/.match?(line)
          fields = line.split(/\s+/)
          pid = fields[1]
          if pid == 'Idle'
            #logger.info('Idle')
            system_process_pids << fields[3].to_i
          else
            if pid == 'Compression'
              #logger.info('Compression')
              system_process_pids << fields[2].to_i
            else            
              system_process_pids << pid.to_i
              #logger.info(system_process_pids)
            end
          end
        end
      end
      ENV['SYSTEM_PROCESS_PIDS'] = system_process_pids.to_json

      # JY @ 2024-2-26: Instantiate here 
      EventNames_To_Drop = ['OperationEnd', 'NameDelete']
      ProcessNames_To_Drop = ['java', 'SilkService']
    "
    code => "
      system_process_pids = JSON.parse(ENV['SYSTEM_PROCESS_PIDS'])
      if system_process_pids.include?(event.get('ProcessID').to_i)
        #logger.info('event.cancel')
        event.cancel
        event.set('[@metadata][drop]', true)
      end
      ###############################################################
      # JY @ 2024-2-26: Filter 'OperationEnd' or 'NameDelete'
      if EventNames_To_Drop.include?(event.get('EventName'))
         logger.info('JY: Filter Unwanted EventName events')
         event.cancel
         event.set('[@metadata][drop]', true)
      end

      # JY @ 2024-2-26: Filter 'java' or 'SilkService'
      if ProcessNames_To_Drop.include?(event.get('ProcessName'))
         logger.info('JY: Filter Unwanted ProcessName events')
         event.cancel
         event.set('[@metadata][drop]', true)
      end       
      ###############################################################
    "
  }
  if [@metadata][drop] {
    drop { }
  }
}
output {
  elasticsearch {
    hosts => ["128.226.117.212:9200"]
    #index => "%{[@metadata][beat]}-%{[@metadata][version]}"
    index => "${LOGSTASH_INDEX}"
    data_stream => false
    }
    stdout { codec => json }
    #user => "elastic"
    #password => "changeme"
  }

